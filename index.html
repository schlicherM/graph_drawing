<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar Chart by Country</title>
    <!-- Google fonts -->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
    <!-- D3.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
    <style>
        body {
            font-family: 'Open Sans', sans-serif;
            font-size: 11px;
            font-weight: 300;
            fill: #242424;
            text-align: center;
            text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff, 0 -1px 0 #fff;
            cursor: default;
        }
        .legend {
            font-family: 'Raleway', sans-serif;
            fill: #333333;
        }
        .tooltip {
            fill: #333333;
        }
        .chart-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .chart {
            margin: 20px;
        }
        .label {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="chart-container" id="chart-container"></div>

    <script src="radarChart.js"></script>    
    <script>
        /* Radar chart design created by Nadieh Bremer - VisualCinnamon.com */

        ////////////////////////////////////////////////////////////// 
        //////////////////////// Set-Up ////////////////////////////// 
        ////////////////////////////////////////////////////////////// 
        var margin = {top: 50, right: 50, bottom: 50, left: 50},
            width = 100,
            height = width;

        ////////////////////////////////////////////////////////////// 
        /////////////////////// Fetch Data ///////////////////////////
        //////////////////////////////////////////////////////////////
        var continents = {
            "Oceania" : ["ASA", "AUS", "COK", "FIJ", "FSM", "GUM", "KIR", "MHL", "NRU", "NZL", "PLW", "PNG", "SAM", "SOL", "TGA", "TUV", "VAN"],
            "Europe" : ["ALB", "AND", "ARM", "AUT", "AZE", "BLR", "BEL", "BIH", "BUL", "CRO", "CYP", "CZE", "DEN", "EST", "FIN", "FRA", "GEO", "GER","GBR", "GRE", "HUN", "ISL", "IRL", "ISR", "ITA", "KOS", "LAT", "LIE", "LTU", "LUX", "MLT", "MDA", "MON", "MNE", "NED", "MKD", "NOR", "POL", "POR", "ROU", "RUS", "SMR", "SRB", "SVK","SLO", "ESP", "SWE", "SUI", "TUR", "UKR"],
            "America" : ["ANT", "ARG", "ARU", "BAH", "BAR", "BIZ", "BER", "BOL", "BRA", "IVB", "CAN", "CAY", "CHI", "COL", "CRC", "CUB", "DMA", "DOM", "ECU", "ESA", "GRN", "GUA", "GUY", "HAI", "HON", "JAM", "MEX", "NCA", "PAN", "PAR", "PER", "PUR", "SKN", "LCA", "VIN", "SUR", "TTO", "USA", "URU", "VEN", "ISV"],
            "Africa" : ["ALG", "EGY", "LBA", "MAR", "SUD", "TUN", "BEN", "BUR", "CPV", "GAM", "GHA", "GUI", "GBS", "CIV", "LBR", "MLI", "MTN", "NIG", "NGR", "SEN", "SLE", "TOG", "CMR", "CAF", "CHA", "CGO", "COD", "GEQ", "GAB", "STP", "BDI", "DJI", "ERI", "ETH", "KEN", "RWA", "SEY", "SOM", "SSD", "TAN", "UGA", "ANG", "BOT", "COM", "SWZ", "LES", "MAD", "MAW", "MRI", "MOZ", "NAM", "RSA", "ZAM", "ZIM"],
            "Asia" : ["BRN", "IRI", "IRQ", "JOR", "KUW", "LBN", "OMA", "PLE", "QAT", "KSA", "SYR", "UAE", "YEM", "AFG", "KAZ", "KGZ", "TJK", "TKM", "UZB", "BAN", "BHU", "IND", "MDV", "NEP", "PAK", "SRI", "CHN", "HKG", "MAC", "JPN", "PRK", "KOR", "TPE", "MGL", "BRU", "CAM", "INA", "LAO", "MAS", "MYA", "PHI", "SGP", "THA", "TLS", "VIE"]
        };

        // Calculate total medals for each category across all countries
        function calculateTotalMedals(jsonData) {
            let totalMedals = {};
            jsonData.links.forEach(link => {
                let category = link.source;  // Use link.source to get the category
                if (category !== "other" && category !== "teams") {  // Exclude "other" and "teams"
                    link.attr.forEach(attr => {
                        if (!totalMedals[category]) {
                            totalMedals[category] = 0;
                        }
                        totalMedals[category]++;
                    });
                }
            });
            return totalMedals;
        }

        // Filter links by country
        function filterLinksByCountry(links, country) {
            return links.filter(link => link.target === country);
        }

        // Calculate medals for each category by country
        function calculateMedalsByCategory(filteredLinks, categories) {
            let categoryTotals = {};
            let totalMedalsForCountry = 0;

            filteredLinks.forEach(link => {
                let category = link.source;  // Use link.source to get the category
                if (category !== "other" && category !== "teams") {  // Exclude "other" and "teams"
                    if (!categoryTotals[category]) {
                        categoryTotals[category] = 0;
                    }
                    link.attr.forEach(attr => {
                        categoryTotals[category]++;
                        totalMedalsForCountry++;  // Increment total medals for the country
                    });
                }
            });

            return categories.map(category => ({
                axis: category,
                value: (categoryTotals[category] / totalMedalsForCountry) || 0  // Normalize by total medals for the country
            }));
        }

        // Prepare data for radar chart for each country
        function prepareRadarChartData(data) {
            const categories = [...new Set(data.links.map(link => link.source))].filter(category => category !== "other" && category !== "teams");  // Get unique categories from data, excluding "other" and "teams"
            let radarData = {};

            data.nodes.forEach(node => {
                if (node.noc) {  // Ensure node has a country code (noc)
                    let filteredLinks = filterLinksByCountry(data.links, node.id);
                    let countryData = calculateMedalsByCategory(filteredLinks, categories);
                    radarData[node.noc] = countryData;
                }
            });

            return radarData;
        }

        // Function to sort the data according to the provided order
        function sortData(data, order) {
            const orderMap = order.reduce((acc, axis, index) => {
                acc[axis] = index;
                return acc;
            }, {});

            const sortedData = {};

            for (const region in data) {
                sortedData[region] = data[region].slice().sort((a, b) => {
                    return orderMap[a.axis] - orderMap[b.axis];
                });
            }

            return sortedData;
        }

        // Fetch JSON data from URL
        fetch('data.json')
            .then(response => response.json())
            .then(jsonData => {
                // Process the JSON data
                const radarChartData = prepareRadarChartData(jsonData);

                // Define the category order
                const categoryOrder = ["boating", "swimming", "cycling", "racquets", "gymnastics", "fighting", "shooting", "equestrian", "athletics"];
                const sortedData = sortData(radarChartData, categoryOrder);

                // Render the radar charts for each country
                var color = d3.scale.ordinal().range(["#00A0B0"]);

                for (let country in sortedData) {
                    let chartContainer = d3.select("#chart-container").append("div").attr("class", "chart");
                    chartContainer.append("div").attr("class", "label").text(country);

                    let radarChartOptions = {
                        w: width,
                        h: height,
                        margin: margin,
                        maxValue: 0.3,
                        levels: 5,
                        roundStrokes: false,
                        color: color
                    };

                    // Create a unique class for each radar chart
                    let chartClass = "radarChart-" + country.replace(/\s+/g, '');
                    chartContainer.append("div").attr("class", chartClass);
                    RadarChart("." + chartClass, [sortedData[country]], radarChartOptions);
                }
            })
            .catch(error => console.error('Error loading JSON:', error));
    </script>
</body>
</html>
