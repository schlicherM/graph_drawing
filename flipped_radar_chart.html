<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar Chart by Continent</title>
    <!-- Google fonts -->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
    <!-- D3.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
    <style>
        body {
            font-family: 'Open Sans', sans-serif;
            font-size: 11px;
            font-weight: 300;
            fill: #242424;
            text-align: center;
            text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff, 0 -1px 0 #fff;
            cursor: default;
        }
        .legend {
            font-family: 'Raleway', sans-serif;
            fill: #333333;
        }
        .tooltip {
            fill: #333333;
        }
        .chart-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .chart {
            margin: 20px;
        }
        .label {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="chart-container" id="chart-container"></div>

    <script src="radarChart.js"></script>    
    <script>
        ////////////////////////////////////////////////////////////// 
        //////////////////////// Set-Up ////////////////////////////// 
        ////////////////////////////////////////////////////////////// 
        var margin = {top: 50, right: 50, bottom: 50, left: 50},
            width = Math.min(300, window.innerWidth - 10) - margin.left - margin.right,
            height = Math.min(width, window.innerHeight - margin.top - margin.bottom - 20);

        ////////////////////////////////////////////////////////////// 
        /////////////////////// Fetch Data ///////////////////////////
        //////////////////////////////////////////////////////////////
        var continents = {
            "Oceania" : ["ASA", "AUS", "COK", "FIJ", "FSM", "GUM", "KIR", "MHL", "NRU", "NZL", "PLW", "PNG", "SAM", "SOL", "TGA", "TUV", "VAN"],
            "Europe" : ["ALB", "AND", "ARM", "AUT", "AZE", "BLR", "BEL", "BIH", "BUL", "CRO", "CYP", "CZE", "DEN", "EST", "FIN", "FRA", "GEO", "GER","GBR", "GRE", "HUN", "ISL", "IRL", "ISR", "ITA", "KOS", "LAT", "LIE", "LTU", "LUX", "MLT", "MDA", "MON", "MNE", "NED", "MKD", "NOR", "POL", "POR", "ROU", "RUS", "SMR", "SRB", "SVK","SLO", "ESP", "SWE", "SUI", "TUR", "UKR"],
            "America" : ["ANT", "ARG", "ARU", "BAH", "BAR", "BIZ", "BER", "BOL", "BRA", "IVB", "CAN", "CAY", "CHI", "COL", "CRC", "CUB", "DMA", "DOM", "ECU", "ESA", "GRN", "GUA", "GUY", "HAI", "HON", "JAM", "MEX", "NCA", "PAN", "PAR", "PER", "PUR", "SKN", "LCA", "VIN", "SUR", "TTO", "USA", "URU", "VEN", "ISV"],
            "Africa" : ["ALG", "EGY", "LBA", "MAR", "SUD", "TUN", "BEN", "BUR", "CPV", "GAM", "GHA", "GUI", "GBS", "CIV", "LBR", "MLI", "MTN", "NIG", "NGR", "SEN", "SLE", "TOG", "CMR", "CAF", "CHA", "CGO", "COD", "GEQ", "GAB", "STP", "BDI", "DJI", "ERI", "ETH", "KEN", "RWA", "SEY", "SOM", "SSD", "TAN", "UGA", "ANG", "BOT", "COM", "SWZ", "LES", "MAD", "MAW", "MRI", "MOZ", "NAM", "RSA", "ZAM", "ZIM"],
            "Asia" : ["BRN", "IRI", "IRQ", "JOR", "KUW", "LBN", "OMA", "PLE", "QAT", "KSA", "SYR", "UAE", "YEM", "AFG", "KAZ", "KGZ", "TJK", "TKM", "UZB", "BAN", "BHU", "IND", "MDV", "NEP", "PAK", "SRI", "CHN", "HKG", "MAC", "JPN", "PRK", "KOR", "TPE", "MGL", "BRU", "CAM", "INA", "LAO", "MAS", "MYA", "PHI", "SGP", "THA", "TLS", "VIE"]
        };

        var country_to_continent_map = {};
        for (var continent of Object.keys(continents)) {
            for (var country of continents[continent]) {
                country_to_continent_map[country] = continent;
            }            
        }

        // Calculate total medals for each category across all continents
        function calculateTotalMedals(jsonData) {
            let totalMedals = {};
            jsonData.links.forEach(link => {
                let category = link.source;  // Use link.source to get the category
                if (category !== "other" && category !== "teams") {  // Exclude "other" and "teams"
                    link.attr.forEach(attr => {
                        if (!totalMedals[category]) {
                            totalMedals[category] = 0;
                        }
                        totalMedals[category]++;
                    });
                }
            });
            return totalMedals;
        }

        function calculateTotalMedalsPerContinent(data, sports = []) {
            let totalMedals = {};
            for (const continent of Object.keys(continents)) {
                const filtered_links = data.links.filter(
                    link => country_to_continent_map[link.target] == continent && sports.includes(link.source)
                );
                totalMedals[continent] = 0;
                for (const link of filtered_links) {
                    totalMedals[continent] += Object.values(link.attr).length;
                }
            }
            return totalMedals;
        }

        // Prepare data for radar chart
        function prepareRadarChartData(data, continents) {
            const categories = Object.keys(continents);
            const sports = [...new Set(data.links.map(link => link.source))].filter(category => category !== "other" && category !== "teams");

            const totalMedals = calculateTotalMedalsPerContinent(data, sports);
            
            let radarData = {};
            for (const sport of sports) {
                let medalsPerThisSport = calculateTotalMedalsPerContinent(data, [sport]);

                let sportData = {};
                for (const continent of categories) {
                    sportData[continent] = medalsPerThisSport[continent]/totalMedals[continent];
                }
                radarData[sport] = sportData;
            }
            return radarData;
        }

        function formatChartData(radarChartData){
            formatted_data = {};
            for (const [category, radar_data] of Object.entries(radarChartData)){
                category_list = [];
                for(const [continent, value] of Object.entries(radar_data)){
                    data_point = {
                        axis: continent,
                        value: value
                    };
                    category_list.push(data_point);
                }
                formatted_data[category] = category_list;
            }
            return formatted_data;
        }

        // Fetch JSON data from URL
        fetch('public/data.json')
            .then(response => response.json())
            .then(jsonData => {
                // Process the JSON data
                const radarChartData = prepareRadarChartData(jsonData, continents);             
                const formatted_data = formatChartData(radarChartData);

                // Render the radar charts for each continent
                var color = d3.scale.ordinal().range(["#00A0B0"]);
                
                for (const sport of Object.keys(formatted_data)) {
                    let chartContainer = d3.select("#chart-container").append("div").attr("class", "chart");
                    chartContainer.append("div").attr("class", "label").text(sport);

                    let radarChartOptions = {
                        w: width,
                        h: height,
                        margin: margin,
                        maxValue: 0.3,
                        levels: 5,
                        roundStrokes: false,
                        color: color
                    };

                    // Create a unique class for each radar chart
                    let chartClass = "radarChart-" + sport.replace(/\s+/g, '');
                    chartContainer.append("div").attr("class", chartClass);
                    RadarChart("." + chartClass, [formatted_data[sport]], radarChartOptions);
                }
            })
            .catch(error => console.error('Error loading JSON:', error));
    </script>
</body>
</html>